{% extends "layout.html" %}

{% block sidebar %}
	{% if onboarding %}
        <div class="column is-1"></div>
    {% else %}
        {{ super() }}
    {% endif %}
{% endblock %}

{% block header %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var compensationSelect = document.getElementById("compensationSelect");
        var giftCards = document.getElementById("giftcardOptions");
        var charities = document.getElementById("charityOptions");
        var submitBtn = document.getElementById("submitBtn");

        function updateFormState() {
            var selectedVal = compensationSelect.value;
            var isValid = false;

            // Reset required states initially
            giftCards.required = false;
            charities.required = false;
            
            // Hide both secondary options by default
            if (!giftCards.classList.contains("d-none")) giftCards.classList.add("d-none");
            if (!charities.classList.contains("d-none")) charities.classList.add("d-none");

            if (selectedVal === "giftcard") {
                giftCards.classList.remove("d-none");
                giftCards.required = true;
                isValid = giftCards.value !== "";
            } else if (selectedVal === "donatecharity") {
                charities.classList.remove("d-none");
                charities.required = true;
                isValid = charities.value !== "";
            } else if (selectedVal === "Decline payment") {
                 isValid = true;
            } else {
                // No valid option selected (e.g. default placeholder)
                isValid = false;
            }

            submitBtn.disabled = !isValid;
             if (isValid) {
                submitBtn.classList.remove("disabled");
            } else {
                submitBtn.classList.add("disabled");
            }
        }

        // Attach listeners
        compensationSelect.addEventListener("change", updateFormState);
        giftCards.addEventListener("change", updateFormState);
        charities.addEventListener("change", updateFormState);

        // Run once on load to set initial state
        updateFormState();
    });
</script>
{% endblock %}
{% block content %}
<div class="container p-4 rounded-1 bg-white shadow-sm onboarding-survey">
    {% if updated %}
    <div class="pref-updated-flash">
        <p>
            <strong>Your information have been updated.</strong>
        </p>
    </div>
    {% endif %}
    <h1>Compensation Settings</h1>

    <p>
        You may get paid to participate in some of our studies or through participation incentives. Please let us know how you’d like to be paid. You can always come back and change this later.
    </p>

    <div class="card mb-4 bg-light border-0">
        <div class="card-body">
            {% if not compensation_period %}
                <p class="text-muted mb-0">
                    <i class="fa fa-info-circle"></i> There’s no active compensation going on.
                </p>
            {% else %}
                <h5 class="card-title text-primary fw-bold">Current Compensation Incentives</h5>
                <p class="card-subtitle mb-3 text-muted">
                    <strong>Event Duration:</strong> 
                    {{ compensation_period.start_date.strftime('%b %d') }} to {{ compensation_period.end_date.strftime('%b %d, %Y') }}
                </p>

                <div class="row">
                    <div class="col-md-7 border-end">
                        <h6><strong>Reward Rules</strong></h6>
                        <ul class="small mb-0 list-unstyled">
                            <li><i class="fa fa-book text-secondary me-2"></i><strong>Reading Activity:</strong></li>
                            <li class="ms-4">Read on 10+ different days: <span class="text-success fw-bold">$5</span></li>
                            <li class="ms-4">Read on 15+ different days: <span class="text-success fw-bold">$10</span></li>
                            <li class="ms-4">Read on 20+ different days: <span class="text-success fw-bold">$20</span></li>
                            
                            <li class="mt-2"><i class="fa fa-check-square-o text-secondary me-2"></i><strong>Survey Activity:</strong></li>
                            <li class="ms-4">Complete 2+ weekly surveys: <span class="text-success fw-bold">$5</span></li>
                            <li class="ms-4">Complete 3+ weekly surveys: <span class="text-success fw-bold">$10</span></li>
                        </ul>
                    </div>

                    <div class="col-md-5">
                        <h6><strong>Your Current Status</strong></h6>
                        {% set clicks = click_and_survey_activity['click_count'] %}
                        {% set surveys = click_and_survey_activity['survey_count'] %}
                        
                        <div class="mb-2">
                            <span class="d-block text-muted small">Active Reading Days: <strong>{{ clicks }}</strong></span>
                            {% if clicks >= 20 %}
                                <span class="badge bg-success">Tier 3 ($20) Unlocked!</span>
                            {% elif clicks >= 15 %}
                                <span class="badge bg-success">Tier 2 ($10) Unlocked!</span>
                            {% elif clicks >= 10 %}
                                <span class="badge bg-info text-dark">Tier 1 ($5) Unlocked</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ 10 - clicks }} reading days to next reward</span>
                            {% endif %}
                        </div>

                        <div>
                            <span class="d-block text-muted small">Surveys Completed: <strong>{{ surveys }}</strong></span>
                            {% if surveys >= 3 %}
                                <span class="badge bg-success">Tier 2 ($10) Unlocked!</span>
                            {% elif surveys >= 2 %}
                                <span class="badge bg-info text-dark">Tier 1 ($5) Unlocked</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ 2 - surveys }} surveys to next reward</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>

    <form action="{{url_for('update_compensation_preference')}}" method="POST">
        <label class="form-label mt-4 fw-bold" for="compensationSelect">Choose your preferred method of compensation:</label>
        <select class="form-select"
            id="compensationSelect"
            title="Select a method of compensation" name="compensation_method" required>
            <option value="" {% if not user_compensation['method'] %} selected {% endif %}>
                Select a method
            </option>
            <option value="giftcard" {% if user_compensation['method']=="giftcard" %} selected {% endif %}>Gift cards</option>
            <option value="donatecharity" {% if user_compensation['method']=="donatecharity" %} selected {% endif %}>Charitable donations</option>
            <option value="Decline payment" {% if user_compensation['method']=="Decline payment" %} selected {% endif %}>Decline payment</option>
        </select>
        <select class="form-select mt-3 {% if user_compensation['method'] != "giftcard" %} d-none {% endif %}"
            id="giftcardOptions"
            title="Select a gift card" name="selected_giftcard">
            <option value="" {% if not user_compensation['option'] %} selected {% endif %}>
                Select a gift card
            </option>
            {% for comp in giftcardopts %}
                <option value="{{comp}}" {% if user_compensation['option']==comp %} selected {% endif %}>{{comp}}</option>
            {%endfor%}
        </select>
        <select class="form-select mt-3 {% if user_compensation['method']!="donatecharity" %} d-none {% endif %}"
            id="charityOptions"
            title="Select a gift card" name="selected_charity" required>
            <option value="" {% if not user_compensation['option'] %} selected {% endif %}>
                Select a charitable organization
            </option>
            {% for comp in donationopts %}
                <option value="{{comp}}" {% if user_compensation['option']==comp %} selected {% endif %}>{{comp}}</option>
            {%endfor%}
        </select>
        <input class="btn pr-btn mt-5 disabled" type="submit" value="Submit" id="submitBtn" disabled>
    </form>
</div>
{% endblock %}
