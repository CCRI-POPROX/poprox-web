{% extends "layout.html" %}

{% block sidebar %}
	{% if onboarding %}
        <div class="column is-1"></div>
    {% else %}
        {{ super() }}
    {% endif %}
{% endblock %}

{% block header %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var compensationSelect = document.getElementById("compensationSelect");
        var giftCards = document.getElementById("giftcardOptions");
        var charities = document.getElementById("charityOptions");
        var submitBtn = document.getElementById("submitBtn");

        function updateFormState() {
            var selectedVal = compensationSelect.value;
            var isValid = false;

            // Reset required states initially
            giftCards.required = false;
            charities.required = false;
            
            // Hide both secondary options by default
            if (!giftCards.classList.contains("d-none")) giftCards.classList.add("d-none");
            if (!charities.classList.contains("d-none")) charities.classList.add("d-none");

            if (selectedVal === "giftcard") {
                giftCards.classList.remove("d-none");
                giftCards.required = true;
                isValid = giftCards.value !== "";
            } else if (selectedVal === "donatecharity") {
                charities.classList.remove("d-none");
                charities.required = true;
                isValid = charities.value !== "";
            } else if (selectedVal === "Decline payment") {
                 isValid = true;
            } else {
                // No valid option selected (e.g. default placeholder)
                isValid = false;
            }

            submitBtn.disabled = !isValid;
             if (isValid) {
                submitBtn.classList.remove("disabled");
            } else {
                submitBtn.classList.add("disabled");
            }
        }

        // Attach listeners
        compensationSelect.addEventListener("change", updateFormState);
        giftCards.addEventListener("change", updateFormState);
        charities.addEventListener("change", updateFormState);

        // Run once on load to set initial state
        updateFormState();
    });
</script>
{% endblock %}
{% block content %}
<div class="container p-4 rounded-1 bg-white shadow-sm onboarding-survey">
    {% if updated %}
    <div class="pref-updated-flash">
        <p>
            <strong>Your information have been updated.</strong>
        </p>
    </div>
    {% endif %}
    <h1>Compensation Settings</h1>

    <p>
        You may get paid to participate in some of our studies. Please let us know how youâ€™d like to be paid. You can always come back and change this later.
    </p>

    <form action="{{url_for('update_compensation_preference')}}" method="POST">
        <label class="form-label mt-4 fw-bold" for="compensationSelect">Choose your preferred method of compensation:</label>
        <select class="form-select"
            id="compensationSelect"
            title="Select a method of compensation" name="compensation_method" required>
            <option value="" {% if not user_compensation['method'] %} selected {% endif %}>
                Select a method
            </option>
            <option value="giftcard" {% if user_compensation['method']=="giftcard" %} selected {% endif %}>Gift cards</option>
            <option value="donatecharity" {% if user_compensation['method']=="donatecharity" %} selected {% endif %}>Charitable donations</option>
            <option value="Decline payment" {% if user_compensation['method']=="Decline payment" %} selected {% endif %}>Decline payment</option>
        </select>
        <select class="form-select mt-3 {% if user_compensation['method'] != "giftcard" %} d-none {% endif %}"
            id="giftcardOptions"
            title="Select a gift card" name="selected_giftcard">
            <option value="" {% if not user_compensation['option'] %} selected {% endif %}>
                Select a gift card
            </option>
            {% for comp in giftcardopts %}
                <option value="{{comp}}" {% if user_compensation['option']==comp %} selected {% endif %}>{{comp}}</option>
            {%endfor%}
        </select>
        <select class="form-select mt-3 {% if user_compensation['method']!="donatecharity" %} d-none {% endif %}"
            id="charityOptions"
            title="Select a gift card" name="selected_charity" required>
            <option value="" {% if not user_compensation['option'] %} selected {% endif %}>
                Select a charitable organization
            </option>
            {% for comp in donationopts %}
                <option value="{{comp}}" {% if user_compensation['option']==comp %} selected {% endif %}>{{comp}}</option>
            {%endfor%}
        </select>
        <input class="btn pr-btn mt-5 disabled" type="submit" value="Submit" id="submitBtn" disabled>
    </form>
</div>
{% endblock %}
