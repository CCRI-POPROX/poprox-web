{% extends "layout.html" %}

{% block sidebar %}
	{% if onboarding %}
        <div class="column is-1"></div>
    {% else %}
        {{ super() }}
    {% endif %}
{% endblock %}

{% block header %}


<script>
    document.addEventListener('DOMContentLoaded', function() {
        const discreteLabels = [{{intlvls | map("first")| map("tojson") | join(', ')}}];
        const topicBlocks = document.querySelectorAll('.pref-item-block');

        // {% if not onboarding %}
        // const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        // {% endif %}

        topicBlocks.forEach(topicBlock => {
            const currentValueDisplay = topicBlock.querySelector('.current-value-text');
            const rangeInput = topicBlock.querySelector('.pref-range-slider');
            rangeInput.addEventListener('input', () => {
                const min = parseFloat(rangeInput.min) || 1;
                const max = parseFloat(rangeInput.max) || 5;
                const value = parseFloat(rangeInput.value);
                const percentage = ((value - min) / (max -min)) * 100;
                rangeInput.style.setProperty('--fill-percentage', `${percentage}%`);
                if (currentValueDisplay) {
                    const actualValue = discreteLabels[value-min];
                    currentValueDisplay.textContent = actualValue;
                }
            });

            {% if not onboarding %}
            rangeInput.addEventListener('change', async () => {
                const newValue = rangeInput.value;
                const topicName = rangeInput.getAttribute('data-topic');

                rangeInput.disabled = true;
                const originalText = currentValueDisplay.textContent;
                currentValueDisplay.textContent = `Saving...`;
                currentValueDisplay.classList.add("text-muted");

                try {
                    const response = await fetch('/update-topic-preference', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            // 'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({
                            topic: topicName,
                            value: newValue
                        })
                    });

                    if (!response.ok) {
                        throw new Error("There was a network error.");
                    }

                    currentValueDisplay.textContent = `Saved`;
                    currentValueDisplay.style.color = "green";

                    // Remove status after 1.5 seconds
                    setTimeout(() => {
                        currentValueDisplay.textContent = originalText;
                        currentValueDisplay.style.color = "";
                    }, 1500);

                } catch (error) {
                    console.error('Error saving preference:', error);
                    currentValueDisplay.textContent = "Failed to save";
                    currentValueDisplay.style.color = "red";
                } finally {
                    rangeInput.disabled = false;
                    currentValueDisplay.classList.remove("text-muted");
                }
            });
            {% endif %}
        });

        // Initialize fill by dispatching input
        const prefRangeInputs = document.getElementsByClassName('pref-range-slider');
        [...prefRangeInputs].forEach((prefRangeInput) => prefRangeInput.dispatchEvent(new Event('input')));
    });
</script>
{% endblock %}

{% block content %}
<div class="container">
	{% if updated %}
		<div class="pref-updated-flash">
			<p>
				<strong>Your preferences have been updated.</strong>
			</p>
		</div>
	{% endif %}
	<div class="row">
		<h2 class="page-header">Customize Your Newsletter</h2>
        <div class="block content">
            <p>
                POPROX presents a sectioned newsletter with top news and specific topic sections based on your preferences. Each section includes three articles selected based on your topic preferences, article feedback, and click history:
                <ul>
                    <li><strong>Your Top Stories</strong> features articles from a list of top stories selected by the Associated Press.</li>
                    <li><strong>Three topical sections</strong>, each focused on a specific topic (e.g., U.S. News, Politics, Entertainment, or Sports) selected based on your topic preferences and available articles.</li>
                    <li><strong>In Other News</strong> highlights three articles from other topics.</li>
                </ul>
                The selection of articles will improve over time as POPROX learns more from your article clicks and the feedback you provide.
            </p>
            <p class="fw-bold">
                Please indicate the topics you prefer to see in your newsletter. POPROX will adjust the articles and topical sections in your newsletter accordingly (where possible).
            </p>
        </div>
	</div>
	<div class="row">
		<form action="/topics" method="POST">

            {% if onboarding %}
            {% else %}
                <input class="btn pr-btn" type="submit" value="Save">
            {% endif %}

            {% set middle_intlvl_index = ( intlvls|length ) //2 %}
            {% set default_intrest_val =  intlvls[middle_intlvl_index][1] %}

			{% for topic in topics %}
				{% set input_name = topic|replace(' ', '_') + "_pref" %}
				<div class="pref-item-block container shadow-sm rounded m-3 p-3">
					<div class="col">
						<div class="topic-top-row row mb-0">
							<div class="col">
								<span class="fw-bold">{{topic}}</span>
                                <span class="hint--bottom-right hint--large" aria-label="{{topic_hints[topic]}}">
                                    <sup style="font-size: 1rem;"><i class="bi bi-question-circle-fill"></i></sup>
                                    <span class="current-value-text fst-italic ms-5"></span>
                                </span>
                                <div class="col text-end">
                                    <span class="current-value-text"></span>
                                </div>
							</div>
							<p class="topic-error" style="color: red; display: none;">Please select at least one option.</p>
						</div>
                        <div class="row m-3">
                            <input
                            name={{input_name}}
                            data-topic="{{topic}}"
                            value="{{user_topic_preferences.get(topic, default_intrest_val)}}"
                            type="range" class="form-range pref-range-slider" min="{{intlvls[0][1]}}" max="{{intlvls[-1][1]}}" step="1" />
                        </div>
                        <div class="row justify-content-between mt-3">
                            <div class="col-auto">
                                {{intlvls[0][0]}}
                            </div>
                            <div class="col-auto">
                                {{intlvls[4][0]}}
                            </div>
                        </div>
					</div>
				</div>
			{% endfor %}
            {% if onboarding %}
                <input class="btn pr-btn" type="submit" value="Submit">
            {% else %}
                <input class="btn pr-btn" type="submit" value="Save">
            {% endif %}
		</form>
	</div>
</div>
{% endblock %}
