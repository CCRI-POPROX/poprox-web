{% extends "layout.html" %}

{% block sidebar %}
	{% if onboarding %}
        <div class="column is-1"></div>
    {% else %}
        {{ super() }}
    {% endif %}
{% endblock %}

{% block header %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const discreteLabels = [{{intlvls | map("first")| map("tojson") | join(', ')}}];
        const topicBlocks = document.querySelectorAll('.pref-item-block');

        topicBlocks.forEach(topicBlock => {
            const currentValueDisplay = topicBlock.querySelector('.current-value-text');
            const rangeInput = topicBlock.querySelector('.pref-range-slider');
            rangeInput.addEventListener('input', () => {
                const min = parseFloat(rangeInput.min) || 1;
                const max = parseFloat(rangeInput.max) || 5;
                const value = parseFloat(rangeInput.value);
                const percentage = ((value - min) / (max -min)) * 100;
                rangeInput.style.setProperty('--fill-percentage', `${percentage}%`);
                if (currentValueDisplay) {
                    const actualValue = discreteLabels[value-min];
                    currentValueDisplay.textContent = actualValue;
                }
            });
        });

        // Initialize fill by dispatching input
        const prefRangeInputs = document.getElementsByClassName('pref-range-slider');
        [...prefRangeInputs].forEach((prefRangeInput) => prefRangeInput.dispatchEvent(new Event('input')));
    });
</script>
{% endblock %}

{% block content %}
<div class="container">
	{% if updated %}
		<div class="pref-updated-flash">
			<p>
				<strong>Your preferences have been updated.</strong>
			</p>
		</div>
	{% endif %}
	<div class="row">
		<h2 class="page-header">Topic Selection survey</h2>
		{% if onboarding %}
			<p>
				This survey is required to complete the enrollment process, but you are free to skip any question you prefer not to answer. Your responses will help the algorithms find articles that match your interests.
			</p>
			<div class="block content">
				<p class="fw-bold">
					Please mark your initial preference by selecting the your level of interest in the following topics.
				</p>
			</div>
		{% else %}
			<div class="block content">
				<p class="fw-bold">
					Here is your latest preference of interest in the following topics. You can edit your preference by clicking new preference level for any following topics.
				</p>
			</div>
		{% endif %}
	</div>
	<div class="row">
		<form action="/topics" method="POST">

            {% if onboarding %}
            {% else %}
                <input class="btn pr-btn" type="submit" value="Save">
            {% endif %}

            {% set middle_intlvl_index = ( intlvls|length ) //2 %}
            {% set default_intrest_val =  intlvls[middle_intlvl_index][1] %}

			{% for topic in topics %}
				{% set input_name = topic|replace(' ', '_') + "_pref" %}
				<div class="pref-item-block container shadow-sm rounded m-3 p-3">
					<div class="col">
						<div class="topic-top-row row mb-0">
							<div class="col">
								<span class="fw-bold">{{topic}}</span>
                                <span class="hint--bottom-right hint--large" aria-label="{{topic_hints[topic]}}">
                                    <sup style="font-size: 1rem;"><i class="bi bi-question-circle-fill"></i></sup>
                                    <span class="current-value-text fst-italic ms-5"></span>
                                </span>
                                <div class="col text-end">
                                    <span class="current-value-text"></span>
                                </div>
							</div>
							<p class="topic-error" style="color: red; display: none;">Please select at least one option.</p>
						</div>
                        <div class="row m-3">
                            <input
                            name={{input_name}}
                            value="{{user_topic_preferences.get(topic, default_intrest_val)}}"
                            type="range" class="form-range pref-range-slider" min="{{intlvls[0][1]}}" max="{{intlvls[-1][1]}}" step="1" />
                        </div>
                        <div class="row justify-content-between mt-3">
                            <div class="col-auto">
                                {{intlvls[0][0]}}
                            </div>
                            <div class="col-auto">
                                {{intlvls[4][0]}}
                            </div>
                        </div>
					</div>
				</div>
			{% endfor %}
            {% if onboarding %}
                <input class="btn pr-btn" type="submit" value="Submit">
            {% else %}
                <input class="btn pr-btn" type="submit" value="Save">
            {% endif %}
		</form>
	</div>
</div>
{% endblock %}
