{% extends "layout.html" %}
{% block header %}
<script>
    document.addEventListener('DOMContentLoaded', function () {

        var racecheckboxes = document.querySelectorAll('input[type="checkbox"][name="race"]');
        var racenotlisted = racecheckboxes[racecheckboxes.length - 1];
        racenotlisted.addEventListener('change', function (event) {
            var raceInputField = document.getElementById('raceinput');
            if (event.target.checked) {
                if (raceInputField) {
                    raceInputField.setAttribute('type', 'text');
                }

            } else {
                if (raceInputField) {
                    raceInputField.setAttribute('type', 'hidden');
                }
            }
        });

        var zipConsentCheckbox = document.querySelector('input[name="zip-consent"]');
        zipConsentCheckbox.addEventListener('change', function (event) {
            var zipInput = document.getElementById('zip');
            if (event.target.checked) {
                zipInput.setAttribute('disabled', 'disabled');
                zipInput.value = '00000';
            } else {
                zipInput.removeAttribute('disabled');
            }
        });

        var zipInput = document.getElementById('zip');
        zipInput.addEventListener('input', function (event) {
            var zip = event.target.value;
            if (zip.length > 5) {
                zip = zip.substring(0, 5);
                event.target.value = zip;
            } else if (zip.length < 5) {
                event.target.setCustomValidity('Please enter a 5 digit ZIP code.');
            } else {
                event.target.setCustomValidity('');
                zipConsentCheckbox.removeAttribute('required');
            }
        });

        var emailCheckboxes = document.querySelectorAll('input[type="checkbox"][name="email_client"]');
        var otherInputField = document.getElementById('clientinput');

        var otherCheckbox = Array.from(emailCheckboxes).find(cb => cb.dataset.other == "true");

        if (otherCheckbox && otherInputField.value) {
            otherInputField.setAttribute('type', 'text');
            otherCheckbox.checked = true;
        }

        if (otherCheckbox) {
            otherCheckbox.addEventListener('change', function (event) {
                if (event.target.checked) {
                    otherInputField.setAttribute('type', 'text');
                } else {
                    otherInputField.setAttribute('type', 'hidden');
                    otherInputField.value = '';
                }
            });
        }
    });

    function validateForm(evt) {
        const checked = (checkbox) => checkbox.checked;
        const emailCheckboxes = [...document.querySelectorAll('input[type="checkbox"][name="email_client"]')];
        const raceCheckboxes = [...document.querySelectorAll('input[type="checkbox"][name="race"]')];

        return emailCheckboxes.some(checked) && raceCheckboxes.some(checked);
    }
</script>
{% endblock %}
{% block content %}
<div class="column box onboarding-survey">
    <h1>POPROX News Subscriber Demographic Form</h1>

	<p>
		Please provide the following information.
        <span class="hint--top-right hint--large"
        aria-label="To test whether studies ran on the POPROX platform make equitable improvements, we ask users to
        answer the following demographic questions. These may also be used to personalize the news recommendations.
        With the exception of ZIP code, this data may be shared with researchers. We ask for your zip code for internal
        use only; your exact zip code will not be shared with external researchers"><strong>(?)</strong></span>
	</p>
    <form action="/demographic_survey" onsubmit="return validateForm()" method="POST">
        <!--Gender input-->
        <div class="field">
            <label class="label">What is your gender identity?</label>
            <div class="control">
                <div class="select" id="genderselect">
                    <select title="Select options for eliciting gender identity." name="gender" required="required">
                        <option value="" selected>Select an option</option>
                        {% for genderopt in genderopts %}
                        <option value="{{genderopt}}">{{genderopt}}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
        <!--Birth year input-->
        <div class="field">
            <label class="label">Please select your birth year.</label>
            <div class="control">
                <div class="select">
                    <select title="Select options for eliciting birth year." name="birthyear" required="required">
                        <option value="" selected>Choose a year</option>
                        {% for year in yearopts %}
                        <option value="{{year}}">{{year}}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
        <!--ZIP code input-->
        <div class="field">
            <label class="label">Enter your 5 digit ZIP code</label>
            <div class="control">
                <input class="input" type="text" name="zip" id="zip" placeholder="ZIP code" required="required">
            </div>
            <div class="checkboxes">
                <label class="checkbox">
                    <input type="checkbox" name="zip-consent" value="00000" required="required">
                    I prefer not to provide my ZIP code
                </label>
            </div>
        </div>
        <!--Education level input-->
        <div class="field">
            <label class="label">
                What is the highest degree or level of education you have completed?
            </label>
            <div class="control">
                <div class="select">
                    <select title="Select options for eliciting level of education." name="education"
                        required="required">
                        <option value="" selected>Select an option</option>
                        {% for edlevel in edlevelopts %}
                        <option value="{{edlevel}}">{{edlevel}}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
        <!--Race input-->
        <div class="field">
            <label class="label">Choose one or more races that you consider yourself to be:</label>
            <div class="checkboxes">
                <ul>
                    {% for raceopt in raceopts %}
                    <li class="checkbox">
                        <label class="checkbox">
                            <input type="checkbox" value="{{raceopt}}" name="race" />
                            {{raceopt}}
                        </label>
                    </li>
                    {% endfor %}
                </ul>
                <div>
                    <input id="raceinput" type="hidden" name="race" class="input" placeholder="Please specify"
                        required="required">
                </div>
            </div>
        </div>
        <!--Email client preference-->
        <div class="field">
            <label class="label">Choose one or more preferred email client:</label>
            <div class="checkboxes">
                <ul>
                    {% set selected_clients = user_demographic_information['email_client'].split(';') if
                    user_demographic_information and user_demographic_information.get('email_client') else [] %}
                    {% for client in clientopts %}
                    <li class="checkbox">
                        <label class="checkbox">
                            <input type="checkbox" value="{{client}}" name="email_client" {% if client in
                                selected_clients%} checked {% endif %} {% if client=="Other" %} data-other="true" {%
                                endif %} />
                            {{client}}
                        </label>
                    </li>
                    {% endfor %}
                </ul>
                <div class="field">
                    {% set custom_email_client = user_demographic_information['email_client_other'] if
                    user_demographic_information and 'email_client_other' in user_demographic_information and
                    user_demographic_information.get('email_client_other')!= None else '' %}
                    <input id="clientinput" type="hidden" name="email_client" class="input" placeholder="Please specify"
                        value="{{ custom_email_client}}">
                </div>
            </div>
        </div>
        <input class="button is-primary" type="submit" value="Submit">
    </form>
</div>
{% endblock %}
