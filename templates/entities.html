{% extends "layout.html" %}

{% block sidebar %}
	{{ super() }}
{% endblock %}

{% block header %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const discreteLabels = [{{intlvls | map("first")| map("tojson") | join(', ')}}];
        const entityBlocks = document.querySelectorAll('.pref-item-block');

        entityBlocks.forEach(entityBlock => {
            const currentValueDisplay = entityBlock.querySelector('.current-value-text');
            const rangeInput = entityBlock.querySelector('.pref-range-slider');
            
            // Initialize display without triggering events
            const min = parseFloat(rangeInput.min) || 1;
            const max = parseFloat(rangeInput.max) || 5;
            const value = parseFloat(rangeInput.value);
            const percentage = ((value - min) / (max - min)) * 100;
            rangeInput.style.setProperty('--fill-percentage', `${percentage}%`);
            if (currentValueDisplay) {
                const actualValue = discreteLabels[value - min];
                currentValueDisplay.textContent = actualValue;
            }
            
            // Add event listener for user interactions only
            rangeInput.addEventListener('input', (event) => {
                // Only trigger if this is a real user interaction, not programmatic
                if (event.isTrusted) {
                    const newValue = parseFloat(rangeInput.value);
                    const newPercentage = ((newValue - min) / (max - min)) * 100;
                    rangeInput.style.setProperty('--fill-percentage', `${newPercentage}%`);
                    if (currentValueDisplay) {
                        const actualValue = discreteLabels[newValue - min];
                        currentValueDisplay.textContent = actualValue;
                    }
                    
                    // Send AJAX request to save preference in real-time
                    const entityName = rangeInput.getAttribute('data-entity-name');
                    if (entityName) {
                        saveEntityPreference(entityName, newValue);
                    }
                }
            });
        });
    });

    function saveEntityPreference(entityName, value) {
        const formData = new FormData();
        formData.append('entity_name', entityName);
        formData.append('preference_value', value);
        
        fetch('/entities/update', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showUpdateConfirmation(entityName);
                
                // Check if this entity was newly added (from search results)
                const entityBlock = document.querySelector('[data-entity-name="' + entityName + '"]');
                const slider = entityBlock.querySelector('[data-is-new="true"]');
                
                if (slider) {
                    // Move entity from search results to saved preferences
                    moveEntityToSavedPreferences(entityName, value);
                }
            }
        })
        .catch(error => {
            console.error('Error saving preference:', error);
        });
    }

    function moveEntityToSavedPreferences(entityName, value) {
        const searchEntityBlock = document.querySelector('#search-results-container [data-entity-name="' + entityName + '"]');
        
        if (searchEntityBlock) {
            // Get entity details
            const entityType = searchEntityBlock.getAttribute('data-entity-type');
            const entityDisplayName = searchEntityBlock.querySelector('.fw-bold').textContent;
            
            // Remove from search results
            searchEntityBlock.remove();
            
            // Add to saved preferences section
            const savedContainer = document.getElementById('saved-preferences-container');
            const noPreferencesMessage = document.getElementById('no-preferences-message');
            
            // Remove "no preferences" message if it exists
            if (noPreferencesMessage) {
                noPreferencesMessage.remove();
            }
            
            // Create new saved preference block
            const newPreferenceBlock = createSavedPreferenceBlock(entityName, entityDisplayName, entityType, value);
            savedContainer.insertBefore(newPreferenceBlock, savedContainer.firstChild);
            
            // Initialize the new slider without triggering save
            const newSlider = newPreferenceBlock.querySelector('.pref-range-slider');
            const newCurrentValueDisplay = newPreferenceBlock.querySelector('.current-value-text');
            
            // Initialize display
            const discreteLabels = [{{intlvls | map("first")| map("tojson") | join(', ')}}];
            const min = parseFloat(newSlider.min) || 1;
            const max = parseFloat(newSlider.max) || 5;
            const sliderValue = parseFloat(newSlider.value);
            const percentage = ((sliderValue - min) / (max - min)) * 100;
            newSlider.style.setProperty('--fill-percentage', `${percentage}%`);
            if (newCurrentValueDisplay) {
                const actualValue = discreteLabels[sliderValue - min];
                newCurrentValueDisplay.textContent = actualValue;
            }
            
            // Add event listener for future user interactions
            newSlider.addEventListener('input', (event) => {
                if (event.isTrusted) {
                    const newValue = parseFloat(newSlider.value);
                    const newPercentage = ((newValue - min) / (max - min)) * 100;
                    newSlider.style.setProperty('--fill-percentage', `${newPercentage}%`);
                    if (newCurrentValueDisplay) {
                        const actualValue = discreteLabels[newValue - min];
                        newCurrentValueDisplay.textContent = actualValue;
                    }
                    
                    const entityName = newSlider.getAttribute('data-entity-name');
                    if (entityName) {
                        saveEntityPreference(entityName, newValue);
                    }
                }
            });
            
            // Show success animation
            newPreferenceBlock.classList.add('preference-updated');
            setTimeout(() => {
                newPreferenceBlock.classList.remove('preference-updated');
            }, 1500);
        }
    }

    function createSavedPreferenceBlock(entityName, entityDisplayName, entityType, value) {
        const discreteLabels = [{{intlvls | map("first")| map("tojson") | join(', ')}}];
        const block = document.createElement('div');
        block.className = 'pref-item-block container shadow-sm rounded m-3 p-3';
        block.setAttribute('data-entity-name', entityName);
        block.setAttribute('data-entity-type', entityType);
        
        block.innerHTML = `
            <div class="col">
                <div class="topic-top-row row mb-0">
                    <div class="col">
                        <span class="fw-bold">${entityDisplayName}</span>
                        <span class="badge bg-success ms-2">${entityType}</span>
                        <span class="current-value-text fst-italic ms-3"></span>
                    </div>
                </div>
                <div class="row m-3">
                    <input
                    name="${entityName.replace(/\s+/g, '_')}_pref"
                    value="${value}"
                    type="range" class="form-range pref-range-slider" 
                    min="{{intlvls[0][1]}}" max="{{intlvls[-1][1]}}" step="1"
                    data-entity-name="${entityName}" 
                    data-entity-type="${entityType}"
                    data-is-new="false" />
                </div>
                <div class="row justify-content-between mt-3">
                    <div class="col-auto">
                        {{intlvls[0][0]}}
                    </div>
                    <div class="col-auto">
                        {{intlvls[-1][0]}}
                    </div>
                </div>
            </div>
        `;
        
        return block;
    }

    function showUpdateConfirmation(entityName) {
        // Find the entity block and show a temporary success indicator
        const entityBlocks = document.querySelectorAll('[data-entity-name="' + entityName + '"]');
        entityBlocks.forEach(block => {
            const entityBlock = block.closest('.pref-item-block');
            if (entityBlock) {
                entityBlock.classList.add('preference-updated');
                setTimeout(() => {
                    entityBlock.classList.remove('preference-updated');
                }, 1500);
            }
        });
    }
</script>
{% endblock %}

{% block content %}
<div class="container">
    {% if updated %}
    <div class="pref-updated-flash">
        <p>
            <strong>Your preferences have been updated.</strong>
        </p>
    </div>
    {% endif %}

    <div class="row">
        <h2>Entity Preferences</h2>
        <div class="block content">
            <p class="fw-bold">
                Search for entities (people, organizations, locations, events) and rate your interest level.
            </p>
        </div>
    </div>

    <!-- Search Section -->
    <div class="row mb-4">
        <div class="col">
            <form action="/entities" method="POST" class="d-flex align-items-center search-form">
                <input type="text" name="search_query" class="form-control me-2" placeholder="Search entities..." value="{{search_query}}">
                <button class="btn pr-btn" type="submit">
                <i class="bi bi-search me-2"></i>Search
            </button>
        </form>
        </div>
    </div>


    <!-- Search Results Section -->
    {% if searched_entities and searched_entities|length > 0 %}
        <div class="row mt-4" id="search-results-section">
            <h3>Search Results</h3>
            <p class="text-muted">Rate these entities to add them to your preferences below</p>
            {% set middle_intlvl_index = ( intlvls|length ) //2 %}
            {% set default_intrest_val = intlvls[middle_intlvl_index][1] %}
            
            <div id="search-results-container">
            {% for entity in searched_entities %}
                    <!-- Only show entities that are not already in user preferences -->
                    {% if entity.name not in user_entity_preferences_dict %}
                        {% set input_name = entity.name|replace(' ', '_') + "_pref" %}
                        <div class="pref-item-block container shadow-sm rounded m-3 p-3" data-entity-name="{{entity.name}}" data-entity-type="{{entity.entity_type}}">
                            <div class="col">
                                <div class="topic-top-row row mb-0">
                                    <div class="col">
                                        <span class="fw-bold">{{entity.name}}</span>
                                        <span class="badge bg-primary ms-2">{{entity.entity_type}}</span>
                                        {% if entity.description %}
                                        <span class="hint--bottom-right hint--large" aria-label="{{entity.description}}">
                                            <sup style="font-size: 1rem;"><i class="bi bi-question-circle-fill"></i></sup>
                                            <span class="current-value-text fst-italic ms-3"></span>
                                        </span>
                                        {% else %}
                                        <span class="current-value-text fst-italic ms-3"></span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="row m-3">
                                    <input
                                    name="{{input_name}}"
                                    value="{{default_intrest_val}}"
                                    type="range" class="form-range pref-range-slider" 
                                    min="{{intlvls[0][1]}}" max="{{intlvls[-1][1]}}" step="1"
                                    data-entity-name="{{entity.name}}" 
                                    data-entity-type="{{entity.entity_type}}"
                                    data-is-new="true" />
                                </div>
                                <div class="row justify-content-between mt-3">
                                    <div class="col-auto">
                                        {{intlvls[0][0]}}
                                    </div>
                                    <div class="col-auto">
                                        {{intlvls[-1][0]}}
                                    </div>
                        </div>
                    </div>
                        </div>
                    {% endif %}
                {% endfor %}
                        </div>
                    </div>
    {% elif search_query %}
        <div class="row mt-4">
            <div class="col">
                <div class="alert alert-info">
                    <i class="bi bi-search-heart"></i>
                    <strong>No results found for "{{search_query}}"</strong>
                    <p>Try searching with different keywords.</p>
                </div>
            </div>
        </div>
        {% endif %}

    <!-- Your Previously Saved Preferences Section -->
    <div class="row mt-5" id="saved-preferences-section">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3>Your Previously Saved Entity Preferences 
                {% if pagination.total_items > 0 %}
                    <small class="text-muted">({{pagination.total_items}} total)</small>
                {% endif %}
            </h3>
            <form action="/entities" method="POST" class="d-flex align-items-center">
                <input type="hidden" name="search_query" value="{{search_query}}">
                <input type="hidden" name="page" value="{{pagination.current_page}}">
                <label for="sort_order" class="form-label me-2 mb-0">Sort by:</label>
                <select name="sort_order" id="sort_order" class="form-select" style="min-width: 180px; width: auto;" onchange="this.form.submit()">
                    <option value="desc" {% if sort_order == "desc" %}selected{% endif %}>Highest Preference</option>
                    <option value="asc" {% if sort_order == "asc" %}selected{% endif %}>Lowest Preference</option>
                    <option value="name" {% if sort_order == "name" %}selected{% endif %}>Alphabetical</option>
                </select>
            </form>
    </div>

        <div id="saved-preferences-container">
        {% if user_entity_preferences and user_entity_preferences|length > 0 %}
                {% for pref in user_entity_preferences %}
                {% set entity_name = pref.entity_name %}
                {% set preference = pref.preference %}
                {% set entity_type = pref.entity_type %}
                {% set input_name = entity_name.replace(' ', '_') + '_pref' %}
                <div class="pref-item-block container shadow-sm rounded m-3 p-3" data-entity-name="{{entity_name}}" data-entity-type="{{entity_type}}">
                    <div class="col">
                        <div class="topic-top-row row mb-0">
                            <div class="col">
                                <span class="fw-bold">{{entity_name}}</span>
                                <span class="badge bg-success ms-2">{{entity_type}}</span>
                                <span class="current-value-text fst-italic ms-3"></span>
                            </div>
                        </div>
                        <div class="row m-3">
                            <input
                            name="{{input_name}}"
                            value="{{preference}}"
                            type="range" class="form-range pref-range-slider" 
                            min="{{intlvls[0][1]}}" max="{{intlvls[-1][1]}}" step="1"
                            data-entity-name="{{entity_name}}" 
                            data-entity-type="{{entity_type}}"
                            data-is-new="false" />
                        </div>
                        <div class="row justify-content-between mt-3">
                            <div class="col-auto">
                                {{intlvls[0][0]}}
                            </div>
                            <div class="col-auto">
                                {{intlvls[-1][0]}}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
                
                <!-- Pagination Controls -->
                {% if pagination.total_pages > 1 %}
                <div class="d-flex justify-content-center mt-4">
                    <nav aria-label="Entity preferences pagination">
                        <ul class="pagination">
                            <!-- Previous Page -->
                            {% if pagination.has_prev %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{pagination.prev_page}}&sort_order={{sort_order}}&search_query={{search_query}}">
                                        <i class="bi bi-chevron-left"></i> Previous
                                    </a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">
                                        <i class="bi bi-chevron-left"></i> Previous
                                    </span>
                                </li>
                            {% endif %}

                            <!-- Page Numbers -->
                            {% set start_page = pagination.current_page - 2 if pagination.current_page > 2 else 1 %}
                            {% set end_page = pagination.current_page + 2 if pagination.current_page + 2 < pagination.total_pages else pagination.total_pages %}
                            
                            {% if start_page > 1 %}
                                <li class="page-item">
                                    <a class="page-link" href="?page=1&sort_order={{sort_order}}&search_query={{search_query}}">1</a>
                                </li>
                                {% if start_page > 2 %}
                                    <li class="page-item disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                {% endif %}
                            {% endif %}

                            {% for page_num in range(start_page, end_page + 1) %}
                                {% if page_num == pagination.current_page %}
                                    <li class="page-item active">
                                        <span class="page-link">{{page_num}}</span>
                                    </li>
                                {% else %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{page_num}}&sort_order={{sort_order}}&search_query={{search_query}}">{{page_num}}</a>
                                    </li>
                                {% endif %}
                            {% endfor %}

                            {% if end_page < pagination.total_pages %}
                                {% if end_page < pagination.total_pages - 1 %}
                                    <li class="page-item disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                {% endif %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{pagination.total_pages}}&sort_order={{sort_order}}&search_query={{search_query}}">{{pagination.total_pages}}</a>
                                </li>
                            {% endif %}

                            <!-- Next Page -->
                            {% if pagination.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{pagination.next_page}}&sort_order={{sort_order}}&search_query={{search_query}}">
                                        Next <i class="bi bi-chevron-right"></i>
                                    </a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">
                                        Next <i class="bi bi-chevron-right"></i>
                                    </span>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>

                <!-- Items per page info -->
                <div class="text-center text-muted mt-2">
                    Showing {{((pagination.current_page - 1) * pagination.per_page + 1)}} to {{(pagination.current_page * pagination.per_page if pagination.current_page * pagination.per_page < pagination.total_items else pagination.total_items)}} of {{pagination.total_items}} entities
            </div>
                {% endif %}
        {% else %}
                <div class="alert alert-light text-center" id="no-preferences-message">
                    <i class="bi bi-star" style="font-size: 2rem; opacity: 0.5;"></i>
                    <h5 class="mt-2">No saved preferences yet</h5>
                    <p class="text-muted">Search for entities above and rate them to build your preferences!</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}